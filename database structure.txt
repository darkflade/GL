CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE TABLE tags (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    value TEXT NOT NULL,
    category SMALLINT NOT NULL DEFAULT 3,
    CONSTRAINT tags_value_cat_unique UNIQUE (value, category) -- Чтобы не дублировать теги
);
CREATE TABLE files (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    path TEXT NOT NULL,       -- Путь на диске (например "a1/b2/uuid.jpg")
    hash TEXT,                -- SHA256 хэш файла
    media_type SMALLINT NOT NULL, -- 0=Pic, 1=Video, 2=Audio
    meta JSONB,               -- Ширина, высота, длительность - лучше в JSONB, гибче
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
CREATE TABLE posts (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    title TEXT NOT NULL,
    file_id UUID NOT NULL REFERENCES files(id), -- Связь с файлом
    description TEXT,         -- Notes к самому посту можно тут
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
CREATE TABLE post_tags (
    post_id UUID REFERENCES posts(id) ON DELETE CASCADE,
    tag_id UUID REFERENCES tags(id) ON DELETE CASCADE,
    PRIMARY KEY (post_id, tag_id)
);
CREATE TABLE playlists (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    title TEXT NOT NULL,
    description TEXT,
    cover_file_id UUID REFERENCES files(id), -- Обложка плейлиста
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    -- owner_id UUID -- раскомментируешь, когда появятся юзеры
);
CREATE TABLE playlist_tags (
    playlist_id UUID REFERENCES playlists(id) ON DELETE CASCADE,
    tag_id UUID REFERENCES tags(id) ON DELETE CASCADE,
    PRIMARY KEY (playlist_id, tag_id)
);
CREATE TABLE playlist_items (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    playlist_id UUID NOT NULL REFERENCES playlists(id) ON DELETE CASCADE,
    position INTEGER NOT NULL, -- Порядковый номер (0, 1, 2...)

    -- ТИП ЭЛЕМЕНТА:
    -- Вариант А: Либо Post, либо Note.
    post_id UUID REFERENCES posts(id) ON DELETE SET NULL, -- Если NULL, значит это заметка
    note_text TEXT, -- Текст заметки. Если post_id не NULL, это может быть комментарий к треку.

    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
CREATE INDEX idx_playlist_items_order ON playlist_items(playlist_id, position);

-- Таблица юзеров
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    username TEXT NOT NULL UNIQUE,
    password_hash TEXT NOT NULL, -- Хэш пароля
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE post_notes (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    post_id UUID NOT NULL REFERENCES posts(id) ON DELETE CASCADE,
    text TEXT NOT NULL,
    pos_x REAL NOT NULL, -- f32
    pos_y REAL NOT NULL  -- f32
);

-- Добавляем владельца к плейлистам
ALTER TABLE playlists ADD COLUMN owner_id UUID REFERENCES users(id) ON DELETE CASCADE;


